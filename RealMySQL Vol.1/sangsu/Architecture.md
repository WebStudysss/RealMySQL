MySQL 서버는 머리 역할을 하는 MySQL 엔진, 손발 역할을 하는 스토리지 엔진으로 구성되어 있다.

# MySQL 엔진 아키텍처

## MySQL의 전체 구조 요약

**프로그래밍**

프로그래밍 API를 활용해 SQL 서버에 쿼리를 실행해 결과를 받아온다.
이 때 프로그래밍 API는 MySQL 서버의 커넥션 핸들러와 통신한다.

**MySQL 서버**

커넥션 핸들러를 통해 들어온 명령은 MySQL 내부에 구현되어 있는 모듈을 활용해 처리된다.
이 때 사용되는 대표적인 모듈은 SQL 인터페이스, SQL 파서, SQL 옵티마이저, 캐시 & 버퍼, 스토리지 엔진 등이 있다.

**디스크**

스토리지 엔진은 SQL 명령에 따라 디스크에 접근해 데이터를 변경|추가|삭제 작업을 진행한다.

## MySQL 엔진

접속 및 쿼리 요청을 처리하는 커넥션 핸들러, SQL 파서 및 전 처리기, 옵티마이저가 있으며, 표준 SQL(ANSI SQL)문법을 지원한다.

요청된 SQL문장을 분석, 최적화하여 스토리지 엔진으로 최적화된 접근 명령을 넘긴다.

## 스토리지 엔진

실제 데이터를 가져오는 역할, 여러개의 스토리지 엔진을 동시에 MySQL 서버에서 동작시킬 수 있으며, 성능 향상을 위해 키 캐시나 버퍼 풀 같은 기능이 내장되어 있다.

## 핸들러 API

각 스토리지 엔진에 읽기|쓰기 요청하는 것을 핸들러 요청이라고 하며, 여기서 사용되는 API를 핸들러 API라고 한다.

## MySQL 스레딩 구조

**포그라운드 스레드(커넥션 연결)**, **포그라운드 스레드(스레드 캐시)**, **백그라운드 스레드**로 나뉘어져 있는 세 스레드를 활용해 명령 처리를 한다.

### 포그라운드 스레드(클라이언트 스레드)

MySQL 서버에 접속된 클라이언트의 수만큼 존재, 각 클라이언트 사용자가 요청하는 쿼리 문장을 처리
각 클라이언트 스레드 사용자가 커넥션을 종료시키면 스레드 캐시 위치로 돌아간다.

InnoDB 테이블은 데이터 버퍼나 캐시까지만 포그라운드 스레드가 처리한다.

### 백그라운드 스레드

- 인서트 버퍼를 병합하는 스레드
- 로그를 디스크로 기록하는 스레드
- InnoDB 버퍼 풀의 데이터를 디스크에 기록하는 스레드
- 데이터를 버퍼로 읽어 오는 스레드
- 잠금이나 데드락을 모니터링하는 스레드

위와 같은 작업들이 대표적인 백그라운드 스레드 작업 유형이고, 요청 받았을 때 포그라운드에서 처리 후 버퍼로 읽어오거나 디스크에 기록하는 작업 들을 위임받아 처리한다.

이처럼 스레드가 나뉘어져 있기에 InnoDB에서는 데이터 쓰기 버퍼링 기능을 사용할 수 있다.

## 메모리 할당 및 사용 구조

글로벌 메모리 영역, 세션(커넥션) 메모리 영역으로 구분되며, 글로벌 메모리 영역에서는 많은 스레드가 공유해서 사용하는 내용인지 여부를 파악하며, 공유하는 내용이면 글로벌, 아니라면 세션 메모리 영역에서 활용된다.

### 글로벌 메모리 영역

- 테이블 캐시
- InnoDB 버퍼 풀
- InnoDB 어댑티브 해시 인덱스
- InnoDB 리두 로그 버퍼

등이 있으며, 모든 스레드와 공유됨

### 로컬 메모리 영역

클라이언트 스레드가 쿼리를 처리하는 데 사용하는 메모리 영역이다.

- 정렬 버퍼
- 조인 버퍼
- 바이너리 로그 캐시
- 네트워크 버퍼

## 플러그인 스토리지 엔진 모델

MySQL은 플러그인을 지원한다. InnoDB 스토리지엔진, 검색파서 등 다양한 기능을 활용할 수 있으며, 사용자가 직접 만든 플러그인도 활용 가능하다.

허나, 하기 단점이 존재한다.

플러그인은 오직 MySQL 서버와 인터페이스할 수 있고, 플러그인끼리는 통신할 수 없으며, MySQL 서버의 변수나 함수를 직접 호출하기 때문에 안전하지 않다.(캡슐화 안됨)
또한 상호 의존 관계를 설정할 수 없어서 초기화가 어렵다.

## 컴포넌트

MySQL 8.0버전부터 상기 단점들을 가진 플러그인 아키텍처를 대체하기 위해 컴포넌트 아키텍처가 지원된다.

## 쿼리 실행 구조

**쿼리 실행 순서**

클라이언트(SQL 요청) → MySQL 엔진 (쿼리 파서 → 전처리기 → 옵티마이저 → 쿼리 실행기) → 스토리지 엔진 → 클라이언트

- 쿼리 파서 : 사용자 요청으로 들어온 쿼리 문장을 토큰으로 분리, 트리 형태의 구조로 변환
- 전처리기 : 파서 트리를 기분으로 쿼리 문장의 정합성 체크(존재 여부, 접근 권한 등)
- 옵티마이저 : 쿼리 문장을 저렴한 비용으로 처리할 수 있는 최적의 조회 방식을 준비
- 실행 엔진 : 옵티마이저가 준비한 데이터를 실제 처리할 수 있도록 핸들러에게 전달하는 역할
- 핸들러(스토리지 엔진) : MySQL 서버의 가장 밑단에서 실행 엔진의 요청에 따라 디스크로 저장 및 읽어 오는 역할을 담당
- 복제 : 데이터 복제
- 쿼리 캐시 : SQL의 실행 결과를 메모리에 캐시하는 역할(MySQL 8.0부터 제거)
- 스레드 풀 : 내부적으로 사용자의 요청을 처리하는 스레드 개수를 활용해 서버의 CPU가 제한된 개수의 스레드 처리에만 집중할 수 있도록 하는 기능 (선 순위 큐, 후순위 큐를 활용해 작업 순서를 재배치)
- 트랜잭션 지원 메타데이터 : 5.7 버전에서는 데이터 딕셔너리의 트랜잭션을 지원하지 않았는데(원자성 보장x) 8.0 버전 부터는 지원한다.
